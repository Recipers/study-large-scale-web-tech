# 13. 다중성 확보, 시스템 안정화
### 100%에  근접한 가동률을 실현하는 원리
## 다중화와 가동률
### 시스템을 얼마나 멈추지 않도록 할 것인가
- 24시간 364일 100$ 가동률
- 실제로는 100%를 달성할 수 있는 시스템으로는 구성하고 있지 않음
- 거의 100%를 목표
- SPOF (Single Point of Failure), 단일장애점 제거
- 한 곳에 장애가 나면 시스템이 멈춰버리는 부분을 가능한 없앰으로써 가동률을 높임
## 13-33. 다중성 확보
### 다중성 확보 
#### AP서버
- AP 서버에서는 확장성을 생각하는 방식과 마찬가지로 서버 여러대를 늘어놓는 게 기본
- 1대나 2대 정도 정지하더라도 충분히 처리할 수 있도록 처리능력을 확보해두는 것
- 서버는 다양한 요인으로 멈춤
- 로드밸런서로 failover, failback
    - 고장 난 서버를 자동적으로 분리 (failover)
    - 서버가 복구되면 원상복귀시키는 작업 (failback)
    - 주기적으로 헬스체크를 하여 AP 서버나 DB 서버가 살아있는지 여부 판정
- failover, failback
    - 서버 하나가 다운됨
    - 로드밸런서가 다운된 상태를 인식해서 다운된 서버로의 접속 차단
    - 시간이 지나 AP 서버가 복귀되었으면 다시 다운된 서버로도 접속요청을 보내도록 처리
### DB 서버
- DB 서버도 마찬가지
- 마스터의 다중화도 수행
- 하테나에서는 멀티 마스터라는 방법 사용
- 멀티 마스터
    - 쌍방으로 레플리케이션
    - 서로가 서로의 슬레이브가 되는 상태로 해둠
    - 한쪽에 쓰기작업을 하면 다른 한쪽으로 전달
- MySQL에서는
    - 한쪽에 쓰기작업을 하면 반대쪽으로 전달되는 흐름
    - 약간의 지연이 있고, 밀리초 단위로 보면 데이터가 일치하지 않는 상태가 항상 존재
    - 동기가 맞지 않는 리스크가 항상 존재
    - 엔터프라이즈에서는 이 부분에 대한 대책으로 레플리케이션을 동기적으로 처리
    - 슬레이브까지 다 쓰여야 클라이언트에 결과 반환
    - 성능면에서는 큰 손실 발생
    - 웹 서비스에서는 동기가 맞지 않는 리스크에 대해서 어느 정도 받아들임
#### 멀티 마스터
- failover에 대해 구제적인 동작
- VRRP (Virtual Router Redundancy Protocol)
- VRRP에 의해 한쪽이 분리된 것을 알게 되면 자신이 Active 마스터로 승격
- Active 마스터로 승격하는 것
    - 멀티마스터 구성에서 서버는 기본적으로 2대 (Active/Stanby)
    - Active쪽만 쓰기작업 구성
    - Active 서버가 다운되면 Stanby였던 쪽이 Active로 승격해서 새로운 마스터가 됨
    - 다운된 서버는 수작업으로 복구 후 Stanby or Active로 원상복구
- VRRP는 원래 라우터용으로 개발된 프로토콜
- 외부에서 어느 쪽 서버가 Active인지 판단하기 위해서 Virtual IP(가상 IP, VIP) 사용
- Active쪽에 원래 할당되어 있는 IP주소와 별도로 서비스용 가상 IP 주소 부여
- AP 서버에서는 항상 가상 IP 주소를 액세스하게 함
- Active 마스터의 전환이 AP 서버 입장에서는 은폐되어 있는 형태
#### 스토리지 서버
- 이미지 파일과 같은 미디어 파일을 저장하기 위한 분산 스토리지 서버로 MogileFS를 사용
- 분산 파일 시스템을 사용함으로써 대량의 파일을 보존할 수 있는 확장성 확보
- 일부 서버가 다운되더라도 전체 장애가 되지 않도록 다중성 확보
- MogileFS는 트래커, 스토리지 노드, 메타 정보를 저장하는 트래커 DB라는 세 가지 요소로 구성
- 실제 파일은 스토리지 노드에 위치
- 특정 URL에 대한 실제 파일의 위치를 나타내는 메타 정보를 DB로 관리하는 형태의 심플한 설계
- 세상에는 다양한 분산 파일 시스템 구현이 있음
   - ex : 거대한 파일을 분할해서 스토리지에 저장하는 등의 구현
   - MogileFS는 파일 분할을 지원하지는 않음
- 스토리지 서버라고 하는 것을 벤더로부터 사면 상당히 비쌈
- 스토리지 1대당 용량을 높이게 되면 저장된 파일의 수가 너무 많아짐
    - 읽기나 쓰기 I/O 성능이 병목되어 100%용량을 다 사용할 수 없게 되는 경우도 발생
- 분산 파일시스템에 이미지 등을 분배
    - 우고메모용 : 닌텐도 DSi에서 보기위한 미디어 파일, PC에서 보기위한 Flash 미디어 파일
    - 우고메모 이외의 스토리지 : 하테나 포토라이프, 다이어리의 이미지, 프로필 이미지
- 예전에는 NFS(Network File System) 마운트 사용
- 분산 파일시스템의 기술
    - 특정 노드가 다운되었을 때 해당 노드가 가지고 있는 데이터를 어떻게 이동시킬 것인지
    - 특정 노드 상의 파일로 액세스가 편중될 때 이를 평준화하기 위해 데이터를 어떻게 재배치할 것인지
## 13-34. 시스템 안정화
### 시스템 안정화를 위한 상반관계
- 시스템을 안정화시키기 위해 상반되는 부분이 몇 가지 있음
    - 안정성과 자원효율
    - 안정성과 속도
- 빠듯한 메모리 튜닝으로 사용 시 
    - 처리해야할 데이터량이 늘어나거나
    - 애플리케이션에 버그가 있거나
    - 메모리에 누수가 발생한 경우
    - 소비 메모리량이 갑자기 수백 MB로 늘어남
    - 스왑을 사용하기 시작해서 성능이 저하됨 -> 서비스 장애로 이어짐
- CPU를 한계에 다다를 정도로 사용
    - 서버 대수를 줄일 수 있어서 비용면에서는 유리하지만
    - 1대에 장애가 발생하면 전체적으로 처리능력이 부족해짐
- 메모리는 7할 정도까지만, CPU는 7할 정도까지만 사용 등 여유를 가질 수 있는 설계 중요
### 시스템 불안정 요인
- 시스템 구성이 복잡해지면 불안정 요인이 늘어남
- 전형적인 요인
#### 애플리케이션/서비스 레벨 -> 부하 증가
1. 기능 추가, 2. 메모리 누수
    - 새로운 기능을 추가하면 그 기능이 예상보다 무거워서 부하가 늘어나 서비스 다운
3. 지뢰
    - 특정 URL이 읽히면 아무리 시간이 지나도 응답이 오지 않아서 마치 지뢰처럼 장애의 원인이 되는 현상
    - 원인으로는 메모리 누수, 무한루프 등 다양한 요인이 있음
    - 지뢰의 원인을 찾는 것은 상당히 어려운 일
    - 시스템이 다운되기 전에 찾아내지 못하면 어디에서 뭐가 지뢰가 되고 있는지 파악하기 어려워짐
    - 디버깅 테크닉 필요
    - 지뢰를 밟더라도 문제가 되지 않도록 설계하는 것도 중요
4. 사용자의 액세스 패턴
    - Slashdot 효과, Digg 효과
    - 인기가 많은 사이트에 링크를 걸어두면 그 사이트 사용자가 집중적으로 접속해서 다운되는 경우
    - 액세스 변동도 흡수할 수 있도록 구성
    - 캐시 서버를 사이에 추가해서 캐시를 반환할 수 있도록 해두는 방법이 있음
5. 데이터량 증가
    - 예상했던 데이터량보다 늘어나서 전체적인 부하의 증가로 이어지는 경우
    - 데이터가 비 정상적으로 늘어나기 시작했다는 것을 빨리 눈치채고 적절한 조치를 취하는 것이 중요
6. 외부연계 추가
    - 웹 API(외부시스템)에 연결하는 것도 불안정 요인
    - 외부시스템이 다운되었을 때 덩달아서 다운되는 형태가 되기 쉬움
    - 외부시스템이 다운되거나 부하가 높을 때에도 연계 서비스가 영향을 받지 않고 충분한 속도로 동작하거나, 다른 부분을 출력할 수 있도록 해야됨
    - 외부 노이즈에 견딜 수 있는 시스템
#### 하드웨어 -> 처리능력 저하
7. 메모리, HDD 장애, 8. NIC 장애
    - 메모리나 HDD, 네트워크 장애는 일상적으로 발생
    - 하드웨어 능력이 저하되더라도 문제가 되지 않도록 해두는 것도 중요
## 13-35. 시스템 안정화 대책
### 실제 안정화 대책
- 적절한 버퍼 유지와 불안정 요인 제거
- 적절한 버퍼 유지를 위해 한계의 7할 운용을 수행
- 불안정 요인 제거를 위해 SQL 부하대책, 메모리 누수 줄이기, 비정상 동작 시 자율제어
- SQL 부하
    - DB에 이상한 SQL을 날리면 멈추면서 다운되어 버림
    - 부하가 높아질 듯한 SQL을 발행하지 않도록 하는 것
    - 부하가 높아질 만한 SQL을 발행할 경우에는 해당 용도를 위해 격리시킨 DB를 준비해 거기로 날리도록 함
- 메모리 누수를 줄이는 것
    - 기본이고 애플리케이션 엔지니어가 매일 수행
#### 이상동작 시의 자율제어
- 이상 동작 시의 자율제어 대책
1. 자동 DoS 판정
    - 1시간에 특정 IP주소로부터 다수의 요청이 오면, 당분간 403을 반환해서 액세스 차단
    - Javascript sleep을 삽입
2. 자동 재시작
    - 리소스를 지나치게 사용했다라고 판단하면 웹 서버를 재시작
3. 자동 쿼리제거
    - 최종 수단에 가까움
    - DB 서버에서 어떤 쿼리가 실행되고 있는지를 파악해서 일정 시간이 경과한 쿼리를 강제적으로 KILL
    - 어떤 액세스를 할 때 그런 SQL이 실행되는지 판명해서 문제를 해결해야함
    - 코드 수정이 필요하므로 곧바로 개선하기에 어려움이 많음
- 자율제어가 지나치게 잘 작동되면 문제를 방치하게될 수도 있음
- 따라서, 자율제어는 잠정적인 해법이고 본질적인 해법이 아님
