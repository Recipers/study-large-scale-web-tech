# 14. 효율향상 전략
### 하드웨어의 리소스 사용률 높이기
## 가상화 기술, 자체제작 서버
### 규모의 크기와 리소스 사용률
- 다중화를 진행하게 되면 기본적으로 리소스 사용률은 저하됨
- 규모가 작을수록 다중화에 따른 효율은 떨어짐
- 하테나에서는 가상화 기술을 사용해서 호스트의 직접도를 상승시킴으로써 전체 리소스 사용률을 올리려고 함
## 14-36. 가상화 기술
### 가상화 기술의 도입
- 가상화 기술의 목적
- 확장성
    - 오버헤드의 최소화
- 비용대비 성능
    - 리소스 사용률 향상
    - 운용의 유연함 (환경의 단순화)
- 고가용성
    - 환경의 격리
- 가상화 기술 구현한 다양한 제품
    - VMware
    - Virtual PC
    - Parallels
    - Xen
### 가상화 기술의 효용
- 가상화 기술을 사용함으로서 얻는 효용
1. IPMI(Intelligent Platform Management Inteferface)를 대체하는 하이퍼바이저
    - 벤더 서버의 IPMI라는 리모트 관리 기능을 대체하는 하이퍼바이저
    - 하이퍼바이저는 호스트 OS를 말함, 서버상에 최초에 기동하는 OS
    - 호스트 OS 상에서 기동하는 OS를 게스트 OS
    - IPMI가 탑재되어 있지 않는 저가의 하드웨어 사용 가능
2. 하드웨어 간 차이 흡수 (환경 추상화)
    - 새로운 하드웨어나 오래된 하드웨어로도 차분에 신경 쓰지 말고 사용할 수 있음
3. 준 가상화 사용
    - Xen에 특화된 이야기
    - 가상화로 인한 오버헤트를 줄이기 위해 하드웨어를 완전히 에뮬레이팅하지 않은 준 가상화 방식
4. 리소스 소비 제어
    - 과부하 경고
    - 부하 조정
### 가상화 서버 구축정책
- 가상화 기술 도입의 가장 기본적인 목적은 하드웨어의 이용효율 향상
- 남아있는 리소스를 사용하는 게스트 OS를 투입
- CPU 리소스가 남아있으면 웹 서버, I/O 리소스가 남아있으면 DB 서버, 메모리 용량이 남아있으면 캐시 서버 투입
- 가상화 기술 도입 시, 중앙에 큰 규모의 스토리지를두고 네트워크로 파일시스템을 마운트하는 구성을 채택하는 경우가 일반적으로 많음
- 고가의 스토리지 서버를 사용하지 않으면, 충분한 안정성을 확보할 순 없음
#### 가상화 서버 - 웹 서버
- 4GB 서버에 웹 서버용 게스트 OS에 3.5GB 할당
- 메모리 8GB 증설 
- 웹 서버용 게스트 OS에 5.5GB 할당
- memcached용 게스트 OS에 2GB 할당
#### 가상화 서버 - DB서버
- DB서버가 메모리는 소비하지만, CPU와 I/O는 그다지 소비하지 않는 경우가 많음
- 웹 서버용 게스트 OS 탑재해서 I/O와 CPU 모두 사용할 수 있도록 함
### 가상화로 얻은 장점 정리
- 물리적인 리소스 제약에서 해방됨으로써 동적으로 변경할 수 있음
- 게스트 OS의 마이그레이션이나 복제가 용이
- 서버 증설이 용이해짐
- 소프트웨어 레벨에서 호스트 리소스를 강력하게 제어할 수 있음
- 비 정상 동작 시 문제를 구소화 시키고 호스트를 쉽게 제어할 수 있게 되었음
- 효율이 향상되고 시스템을 전체적으로 안정화할 수 있게 됨
### 가상화와 운용
- 서버관리툴로 운용측면에서 가상화의 장점을 살리다
- 서버 관리 시스템을 만들어서 함께 운용하면 가상화의장점을 살릴 수 있게됨
- 가상화된 환경에서는 게스트 OS를 특정 호스트에서 다른 호스트로 이동시키는 일이 자주 있음
### 가상화 도입 시 주의할 점
- 가상화의 단점
- 성능상의 오버헤드가 있음
- 하테나 경험치로는 다음과 같은 수치를 오버헤드의 기준으로 삼고 있음
    - CPU에서 2~3%
    - 메모리 성능에서 1할 정도
    - 네트워크 성능은 절반 정도
    - I/O 성능이 5% 정도 떨어짐
- 가상화 기술 구현상 결함으로 인해 갑자기 네트워크가 단절되는 등의 불안정 요인이 약간 늘어남
    - 이에 비해 장점이 큼
- 네트워크 성능이 반감하는 것은 용도에 따라서는 꽤 심각
- PC 라우터에서는 가상화를 사용하기 때문에 성능이 떨어지는 경우가 있었음
- 가상화 기술이 병목현상의 원인이였음
- 용도에 따라서는 가상화를 도입하지 않고 사용
## 14-37. 하드웨어와 효율향상
- 저비용을 실현하는 요소기술
### 프로세서의 성능향상
- 무어의 법칙
    - 집적회로 상의 트랜지스터수는 18개월마다 2배로 증가
    - 트랜지스터의 집적도에 대한 이야기
    - 코어 수의 경우 앞으로 더 늘어날 것이며 서버 용도로 사용하고 있는 한 성능은 증가해 갈 것
### 메모리, HDD의 비용저하
- 메모리나 HDD는 급속하게 저렴해지고 있음
#### 메모리, HDD 가격추이
- 웹 서비스 제공업자는 가격 하락이라는 변화를 인프라에 즉각적으로 잘 반영하면서 가격 메리트를 살려가는 것이 경쟁우위로 이어질 것
### 저가 하드웨어의 유용한 이용법
- 가상화를 전제로 한 하드웨어 사용
- 관리기능은 최소한으로 억제
- 코어가 가능한 많은 것을 채택
- 메모리는 충분히 저렴하므로 상한선까지 탑재
- I/O 성능에 관해서는 용도별로 요구되는 레벨이 많이 다름, 다른 패턴을 갖추고 있음
    - 디스크가 없는 서버
    - 하드웨어 RAID를 통한 RAID-10을 구성
    - SSD로 RAID-0 등을 구성
- IPMI와 같은 관리용 하드웨어는 불필요한 비용
    - Intel AMT라는 데스큽용 마더보드에도 포함되어 있는 기능으로 대체
    - 가상화 기술로 게스트 OS를 소프트웨어적으로 분리
- 가상화를 전제로 한 하드웨어 구성
    - 데스크톱용 마더보드 (Intel AMT)
    - 데스크톱용 CPU
    - 네트워크 포트
    - ECC (Error Check and Correct) 없는 메모리
    - RAID (Redundant Arrays of Inexpensive Disks) 없음 또는 소프트웨어 RAID
### SSD
- SSD와 같은 새로운 기술을 점차 적극적으로 도입해가는 것은 매우 중요하므로 다양하게 시도
- 하테나는 다수의 DB 슬레이브 서버에서 사용
- SSD를 사용하고 있는 서버의 CPU 부하
    - I/O read가 상당히 발생하고 있음에도 불구하고 I/O 대기는 거의 발생하지 않음
    - I/O read는 매우 낮은 부하만 유발하며 잘 처리되고 있음
    - Load Average도 32GB 메모리 탑자한 서버와 비슷한 정도로 처리
    - 하드웨어 비용을 1/4 정도로 내리면서 성능면에서 거의 변함없음
### SSD의 수명
- 문제가 되는 현상에 대해서는 HDD만큼 밝혀진 바 없음
- 언제 어떻게 고장날 것인지가 신경쓰이는 부분
- SSD의 소모빈도 지표가 되는 것은 S.M.A.R.T 값인 E9(Media Wearout Indicator)라는 항목
- SSD의 기록 미디어인 플래시 메모리의 소모빈도
- 평균 삭제횟수가 늘어남에 따라 정규화된 값이 100에서 1로 감소
- 하테나에서 가장 심하게 쓰기작업을 하는 SSD에서는 9개월 정도에 이 값이 0이 되어버림
- 언제 고장나도 이상하지 않을 상태라는 뜻
