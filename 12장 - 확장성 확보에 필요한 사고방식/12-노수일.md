# 12. 확장성 확보에 필요한 사고방식
### 부하에 따른 확장
- 대규모 서비스는 수십 대의 서버로
- 규모 증대에 따라 시스템을 얼마나 확장해서 대응할 수 있도록 해둘 것인지 살펴봄
- 확장성 확보에 필요한 사고방식을 설명
- 하테나에 수십 대의 서버로 구축하고 각각의 서버는 4 core CPU 1~2개와 8~32GM 메모리 탑재함으로 부하에 따라 확장
## 12-31. 계층과 확장성
### 확장성에 대한 요구
- 서버 1대에서 처리할 수 있는 트래픽 한계
- 최근 서비스 중 상당수는 서버 1대로 작동
- 하테나 표준 사양인 4core CPU, 8GB 메모리 정도의 서버를 사용하면 피크 시 성능이 수천 요청/분 정도
- 경험상 짐작으로 얻어진 수치이므로 동작 애플리케이션에 따라 크게 바뀔 수 있음
- 피크 시 성능이 수천 요청/분 정도면 월 100만 PV(page view) 정도를 처리할 수 있음
- 좀 더 높은사양 (4 core CPU 2개, 32GB 메모리 서버) 는 수천~1만 건/분 정도의 요청을 처리할 수 있음
- 하테나의 경우 한 서비스에 수억 PV/월 정도의 트래픽 발생
### 계층별 확장성
- AP 서버는 비교적 간단하게 확장시킬 수 있음
    - 상태를 가지고 있지 않으므로 요청별로 다른 AP 서버로 날려보내도 처리상 문제가 발생하지 않음
    - 로드밸런서에 새로운 서버를 추가해가면 점점 확장되어 감
- DB나 파일 서버는 분산, 확장성 확보가 매우 어려움
    - read는 용이
    - write는 매우 어려움
## 12-32. 부하 파악, 튜닝
### 부하 파악
- 가시화한 관리화면
- 어떻게 확장할 것인지 검토하기 위해서는 먼저 서버 부하를 파악할 수 있어야 함
- 서버군을 관리하고 각각의 부하를 적절하게 그래프화하는 것이 중요
- 하테나 서버 관리툴 예시
    - 서버의 역할이 나열되어 있음
    - 백엔드 서버 19대
    - 배치 서버 2대
    - bdog, bsim 특수 엔진, 커스터마이징 엔진
    - db 서버가 용도별로 나누어져 있음
    - Hadoop, lvs(Linux Virtual Server : 로드밸런서), memcached, 리버스 프록시
### 부하를 측정하기 위한 항목
- Load Average, 메모리 관련, CPU 관련
- 부하를 볼 때 먼저 Load Average부터 봄
- Load Average
    - 프로세스가 언제든지 동작할 수 있는 상태이지만, 아직 실제 CPU가 할당되지 않아서 대기상태에 있는 프로세스 수의 평균치
    - CPU가 깔끔하게 할당되면 이 값이 0에 가까워지고, CPU 코어 수 이하면 양호한 편
    - 용도에 따라서는 Load Average가 CPU 코어 수의 몇 배에 달하도록 일부러 제어하는 곳도 있음
- Load Average 외에 부하를 측정하기 위한 항목은 메모리 사용처
    - 사용자 공간이 소비되고 있는 메모리나 공유되고 있는 메모리, 커널이 사용하고 있는 버퍼의 메모리 등
### 용도에 맞는 튜닝
- 사용자용 서버, 봇용 서버
- 서버관리툴로 북마크의 백엔드 부하를 살펴보면 그래프가 겹쳐진 상태
- 위와 아래 둘로 나위어 보이는데 용도별로 나누어진 그림
1. AP 서버 전체의 부하
2. 봇용 서버의 부하
    - 봇은 응답시간이 그다지 중요하지 않으므로 요청 처리수를 최대화시키는 방향으로 튜닝
    - Load Average도 높게 나타남
- 사용자용 서버는 사용자의 활동에 따라 부하가 점차 변동하고, 트래픽에 따라 부하가 변동됨
    - 심야때 떨어지고 낮에 높음
- 봇과 사용자를 분리함에 따라
    - AP 서버의 튜닝 정책을 변경해서 효율을 중시할지
    - 응답시간을 중시하는 쪽으로 이끌어갈지
    - 리소스를 최대한 사용하는 것을 중시하는 쪽으로 운영할지
### AP 서버/DB 서버의 튜닝 정책과 서버 대수
- 사용자 대상으로 한 투닝인 채로 봇용에 투입해서 동일한 부하로 처리하면, 봇용 서버 대수가 늘어나게 됨
- 용도별로 튜닝을 변경함으로 서버 대수를 줄일 수 있음, DB도 마찬가지
### 서비스 규모와 튜닝
- 서버 용도나 계층에 입각한 튜닝은 서비스별로 수행
- 하테나 다이어리 서버 대수가 가장 많고 AP 서버가 종류별로 더 세세하게 나누어져 있음
- 주변 다른 서버도 그 나름의 서버 대수가 있음
- 튜닝 작업을 반복하다 보면 서버 대수가 늘어났을 때 비정상적인 거동을 하고 있는 서버를 찾을 수 있는 방법을 알아내는 게 과제가 됨
- 30대 AP 서버 중 1대에 이상이 발생했을 때 해당 서버를 어떻게 파악할 수 있을까?
    - 예전에는 그래프를 1대씩 살펴봄 -> 파악하기 어려움
    - 그래프를 겹쳐서 1대만 비정상적인 값이 나타났을 경우에 파악하기 쉽도록 함
    - Load Average는 정상인데 CPu나 메모리를 사용하는 방식이 이상하다는 등 다양한 패턴이 있어서 시행착오가 계속 됨
### 확장성 확보
- 확장성 확보를 위해 로드밸런서를 이용하거나 파티셔닝(DB분할)을 하고 있음
- 하테나에서는 LVS 로드밸런서 사용
- 확장성 고려한 인프라 구축 방법에는 서버/인프라를 지탱하는 기술 참조
