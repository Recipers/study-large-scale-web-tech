# 15장 - 웹 서비스와 네트워크
## 1Gbps를 넘어, 500호스트를 넘어, 태평양을 넘어
- 트래픽이 많지 않다면 각 서버를 `아무 생각 없이 스위치에 연결`하고 `라우터를 하나`만 준비해도 괜찮음
- 하테나도 책을 쓸 당시 2년 전 규모일 때까지는 위와 같은 방식으로 구성해도 문제가 없었음
- 특정 구간(특히 트래픽이 Gbit 단위, 1Gbps)이 되면 `아무 생각 없이 스위치 연결 + 라우터 하나` 그 이상이 필요하다.
	- `라우터의 성능 관점`에서 bps보다 패킷/초인 **pps가 중요**
		- 하테나에서 사용 중인 PC 라우터는 30만 pps가 넘어서면 한계
	- 호스트수는 500을 넘는데, **하나의 서브넷**으로 구성하게 되어 있다면 **여러 문제**와 **패킷 손실** 발생
	- 북미나 유럽 등 글로벌로 서비스를 전개하는데 **데이터 센터는 한 곳**이라면 태평양이나 대서양을 지나는 트래픽이 발생해 latency 발생

> **웹 서비스와 네트워크**
> - 네트워크 분기점 (강의 38)
> 	- 1Gbps의 한계
> 	- 500호스트의 한계
> 	- 글로벌화, CDN
> - 한층 높은 단계 (강의 39)

- - -
## 강의38: 네트워크 분기점
### 서비스 성장과 네트워크 분기점
- 서비스의 성장에 따라 네트워크 분기점을 알아야 함
	- 1Gbps(라우터 성능 관점에서 30pps(300Kpps)) 이상 -> PC라우터의 한계
	- 500 호스트 이상 -> 1서브넷의 한계
	- 글로벌화 -> 1데이터 센터의 한계
- 하테나는 위 조건 모두 한계에 봉착해 새로운 기술과 사고방식 투입해야 되는 시기

### 1Gbps의 한계 - PC 라우터의 한계
- 1Gbps의 한계는 정확히 30만 pps의 한계다.
	- 책이 쓰여진 당시 표준적인 하드웨어에서 최신 Linux 커널을 사용하면 대략 `30만 패킷/초` 한계
	- 평균 패킷 길이가 300바이트라먄 대략 1Gbps가 됨
- 이에 대한 대책으로 PC 라우터를 여러 대 병렬화, 박스형 라우터(고가의 Cisco 라우터) 구입
	- 하테나에서는 저가의 PC 라우터를 병렬화하는 방향으로 노력
	- 박스형 라우터를 구입하면 대략 1대에 백만 엔에서 수백만 엔이 필요하므로 선택하지 않음

> **1Gbps의 한계**
> - PC 라우터의 전송능력이 한계
> 	- 30만ppc(300Kpps) = 1Gbps(평균 패킷 길이 300바이트)
> - 대책
> 	- PC 라우터를 나열한다. -> 하테나의 방식
> 	- 박스형 라우터를 구입한다.

### 500호스트의 한계 - 1서브넷, ARP 테이블에서의 한계
- 500호스트의 한계는 구체적으로 스위치의 **ARP 테이블(Address Resolution Protocol table)**과 관련해서 한계가 있음
- ARP를 간단히 설명하면 다음과 같음
	- Ethernet 통신이라는 것은 MAC주소를 기반으로 한다. ARP 테이블이란 IP 주소와 MAC 주소 간 대응 관계표로 스위치는 이 테이블을 갖고 있다.
	- IP 통신을 할 때는 먼저 IP 주소로 통신 대상을 지정하면 이에 대응하는 MAC 주소를 검색한 후, Ethernet 계층에서 MAC 주소를 사용해 통신하게 됨
	- 받아들이는 쪽은 그 내용을 IP 계층까지 확인해서 다른 서브넷으로 보낼지 서브넷 내에서 통신을 마칠지 결정해서 통신을 실현한다.
- ARP 테이블의 한계에 걸려 특정 호스트로 ping이 가지 않은 적이 있었음
	- 이때 1서브넷은 500호스가 한계라고 기억해둠
- 서브넷 내에 호스트를 많이 두면 브로드캐스팅 패킷이 서서히 증가함
	- 점차 이 트래픽이 무시할 수 없을 정도가 되어 브로드캐스팅 패킷을 수신하는 것 만으로 CPU를 약간 잡아먹게 되기도 함. (극단적인 예로 호스트가 많이 있는 서브넷의 스위치에 Ethernet 케이블을 연결하는 것만으로 CPU 부하가 올라가는 것을 관측했음)
	- 1서브네트에 수백 호스트를 나열하면 이런 상황을 관측할 수 있으며, 브로드캐스팅 통신에 의존한 처리가 많아지면 Ethernet을 연결하는 것만으로 CPU 부하가 수십%까지 올라가기도 함
- 따라서 1서브넷 내의 서버 대수는 어느 정도로 억제하는 편이 좋음
	- 이 분기점을 대략 **1 서브넷은 500호스트 정도**

> **500호스트의 한계**
> - 1 서브네셍 배치할 수 있는 호스트 수 = 약 500
> - 스위치의 ARP 테이블
> - 브로드캐스팅 패킷의 트래픽 -> 패킷 손실이 발생

### 네트워크 구조 계층화
- 지금까지 언급한 문제의 대책은 **네트워크 구조의 계층화**가 best practice로 확립되어 있다.
	- 이를 위해 네트워크 구조 계층을 3단 구조 구성하는 것이 일반적이다.
1. 가장 작은 것은 **Access 계층**
2. 중간으로 **Distribution 계층**
3. 가장 위로 **Core 계층** 또는 **OSPF(Open Shortest Path First) 영역**
- 가장 적은 서브넷에서 100대, 200대 디스트리뷰션 1000대 코어 전체로는 10000대 설계하는 것이 일반적
- 또한 디스트리뷰션 영역 간 트래픽을 제어해 너무 증가하지 않도록 하거나, 서브넷 간 통신량을 제어하는 등 이런 부분도 신경을 쓰게 되는 것이 수백 대 이상이 되었을 때 주의해야 할 부분
<img src="../image/Pasted image 20250502210606.png" width="800" height="550">

### 글로벌화
- 태평양을 넘는 액세스는 상당한 오버헤드이다.
	- 하테나 데이터 센터에 우고메모의 FLV 파일(Flash Video, 최대 5~6MB 정도 크기)를 세계 각지에서 HTTP로 가져가려고 하면 대략 20~30초가 걸림
	- 테스트 시 타임아웃을 30초로 했을 때 타임아웃 비율이 5할을 넘을 정도로 타임아웃이 자주 발생
- 이때 CDN을 사용하면 5~6초 만에 파일을 받을 수 있음 - 글로벌을 하려면 필수

#### CDN 선택방안
- 가격, CDN 서버의 위치 등 잘 확인하고 선택하자.

- - -
## 강의39: 한층 높은 단계로
### 10Gbps 이상의 세계
- 10Gbps의 세계면 `AS 번호(Autonomous System number)`라는 것을 보유하고, `IX(Internet exchange)`에 접속해 트래픽을 교환하거나 `BGP(Boarder Gateway Protocol)`라는 인터넷의 라우팅을 제어하는 프로토콜을 사용한다.
	- 하테나는 여기를 목표로 하고 있음
### 하테나의 인프라 - 11장 ~ 15장 정리
- 웹 서비스의 인프라의 특징
	- 저비용, 높은 확장성
	- 적당하면서 충분히 높은 신뢰성
- 각종 기술로는 다음과 같음 `확장성`, `다중화`, `효율향상`, `네트워크`
- 하테나는 서버 관리툴 전부 자체적으로 제작

