# 15. 웹 서비스와 네트워크
### 서비스의 성장
## 1Gbps를 넘어, 500호스트를 넘어, 태평양을 넘어
### 트래픽, 호스트수, 서비스 전개
- 트래픽이 Gbit 단위, 1Gbps가 되면 여러 문제가 발생
- 라우터 성능 관점에서는 bps보다는 패킷/초인 pps가 중요
- 하테나의 경우 30만 pps가 넘어서면 한계에 이르러서 이 부분이 하나의 포인트가 됨
- 호스트수가 500을 넘어서는 상태에서 하나의 서브넷으로 구성하게 되면, 여러 가지 문제가 생김
- 글로벌 서비스 전개 시, 데이터 센터 한 곳으로 운영하면 태평양, 대서양을 지나는 트래픽이 발생해서 latency도 한계에 이름
## 15-38. 네트워크 분기점
### 서비스 성장과 네트워크 분기점
- 1Gpbs (라우터 성능 관점에서는 30만 pps(300만Kpps)) 이상
    - PC 라우터의 한계
- 500 호스트 이상
    - 1 서브넷의 한계
- 글로벌화
    - 1 데이터 센터의 한계
### 1Gbps의 한계
#### PC 라우터의 한계
- 1Gbps의 한계는 정확히는 30만pps의 한계
- 표준적인 하드웨어에서 최신의 Linux 커널을 사용하면 대략 30만 패킷/초 실측
- 이에 대한 대책
    - PC 라우터를 여러 대 병렬화
    - 박스형 라우터, 고가의 라우터
### 500호스트의 한계
#### 1 서브넷, ARP 테이블에서의 한계
- 스위치의 ARP 테이블과 관련해서 한계가 있을 듯 함
- Ethernet 통신은 MAC 주소 기반
- ARP 테이블이란 IP 주소와 MAC 주소 간 대응관계표로 스위치는 이 테이블을 가지고 있음
- IP 통신을 할 때 먼저 IP 주소로 통신대상을 지정하면 이에 대응하는 MAC 주소를 검색한 후, Ethernet 계층에서 이 MAC주소를 사용해서 통신
- 받아들이는 쪽은 그 내용을 IP 계층까지 확인해서 다른 서브넷으로 보낼지 서브넷 내에서 통신을 마칠지 결정
- 스위치에서는 이 ARP 테이블의 크기가 대략 수백 건 정도
- ARP 테이블 상한선이 900건 전후였는데, 800건 이상 늘어나니 특정 호스트로만 ping이 가지 않는 등 통신을 할 수 없었음
- 서브냇 내에 호스트를 많이 두면 브로드캐스팅 패킷이 서서히 증가함
- 이 트래픽이 무시할 수 없을 정도가 되어 브로드캐스팅 패킷을 수신하는 것 만으로도 CPU를 약간 잡아먹게 됨
- 1 서브넷 내의 서버 대수는 억제하는 편이 현명함
### 네트워크 구조 계층화
- 네트워크 구조의 계층화는 최선의 관행으로 확립
- 3단 구조로 구성하는 것이 일반적
    1. 가장 작은 것은 Access 계층
    2. 그 다음이 Distribution 계층
    3. 가장 위가 Core 계층 또는 OSPF 영역
- 가장 작은 서브넷에서 100대, 200대로 억제하고
- 디스트리뷰션을 1,000대 정도로
- 코어 전체로는 10,000대 단위를 다룰 수 있다는 계층구조를 설계하는 것이 일반적
- 디스트리뷰션 영역 간 트래픽을 제어해서 너무 증가하지 않도록 한다거나 서브넷 간 통신량을 제어하는 등 
### 글로벌화
- 하테나 데이터 센터에 우고메모 FLV 파일을 세계 각지에서 HTTP로 가져가려 한다면 대략 20~30초
- 타임아웃을 30초로 했을 때 타임아웃 비율이 5할을 넘김
- 수MB 단위의 파일을 태평양 너머 전송하는 것은 상당한 오버헤드임
- CDN을 사용하면 상황은 크게 달라짐
- CDN을 사용하면 대략 5~6초 만에 파일을 받을 수 있으며, 타임아웃도 거의 발생하지 않고 양호한 응답시간 유지 가능
#### CDN 선택방안
- Content Delivery Network
- 세계 각지에 서버를 두고 거기에 미디어를 캐싱시켜서 사용자가 가지러 갈 때에 가장 가까운 서버로 엑세스해서 미디어를 다운로드 하도록 함
- Amazon Cloudfront는 서버가 지구 상 각지에 있음
#### Amazon Cloudfront
- Amazon Cloudfront는 원본 데이터를 일본 내 데이터 센터에 둠
- 참조빈도가 높은 파일을 Amazon S3에 업로드하고 다운로드는 Amazon Cloudfront로 전송하는 형태
- 동작 방식
    - 우고메모에 미더어를 올리면 포맷 변환
    - 변환한 미디어 파일을 S3에 동시에 업로드
    - 우고메모의 HTML을 출력할 때 Amazon Cloudfront의 URL로 지정
## 15-39. 한층 높은 단계로
### 10Gbps 이상의 세계
- 현재 하테나가 부딪치고 한계 보다 더 높은 단계인 10Gpbs 이상의 세계가 있음
- AS라는 것을 보유하고 IX에 접속해서 트래픽을 교환하거나 BGP라는 인터넷 라우팅을 제어하는 프로토콜을 사용함
- 이 정도 규모에서는 잘못 제어하게 되면 다른 사이트에도 영향을 미침
- BGP를 통해 잘못된 라우팅 정보를 흘려보내면 이 사이트의 트래픽 제어를 제대로 할 수 없어 특정 지역에서는 특정 사이트를 볼 수 없게됨
- AS번호는 BGP로 트래픽을 제어하기 위한 기본적인 번호지만, 통신사업자나 ISP뿐만 아니라 동영상 서비스를 하는 콘텐츠 프로바이더 보유하고 있는 것 같음
### 하테나의 인프라
- 웹 서비스 인프라의 특징
    - 저비용, 높은 확장성
    - 적당하면서 충분히 높은 신뢰성
- 각종 기술
    - 확장성
    - 다중화
    - 효율향상
    - 네트워크
- 인프라는 프로그램 코드와 조금 거링가 있는 세계이지만, 안정된 인프라가 있어야 안정된 서비스 실현 가능
- 인프라 관련 지식을 지닌 상태에서 애플리케이션 코드를 작성하면 보다 품질 높은 서비스를 완성할 수 있음
